<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>客户沟通增强</title>
    <script src="https://open.work.weixin.qq.com/wwopen/js/jwxwork-1.0.0.js"></script>
    <script src="https://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/crypto-js/4.1.1/core.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/crypto-js/4.1.1/sha1.js"></script>
</head>
<body>
<button onclick="context()">检测调用入口</button>

<table style="border-collapse: collapse;text-align: center;">
    <tr>
        <th>常用语</th>
        <th>发送</th>

    </tr>
    <tr>
        <td>你好！</td>
        <td>
            <button onclick="send1()">发送</button>
        </td>
    </tr>
    <tr>
        <td>再见！</td>
        <td>
            <button onclick="send2()">发送</button>
        </td>
    </tr>
</table>
<div id="text"></div>

<table>

</table>

</body>
<script>
    let agentId = '1000002'
    let corpId = 'wwa70dc5b6e56936e1'
    let secret = 'Y7R73gG_xSgbNmFR32x2AmOdxdH0pcn4HVNpjbhfybs'

    // https://qyapi.weixin.qq.com/cgi-bin/gettoken?corpid=wwa70dc5b6e56936e1&corpsecret=Y7R73gG_xSgbNmFR32x2AmOdxdH0pcn4HVNpjbhfybs


    let token = 'qPKsmS32-uP1lM5g-YXgzCpRe7tKsJE2ijrUncNpoMZ-Bq_ouJMBFiZGViDt0Q9s9tL2fsX7GD0Ou6FND8-vt9VBYLfyFwR9Tj7NIoJ3f58JrAKeIkvJDs3KhaWSi1r1OWqogKHKK7spCBURRAgrEg6rNIstDlHkvyIXIkTiP4V5YCiTw1Er7l99ObdYAgVEjVuct8IZ1GO05detsxvuEQ';
    // https://qyapi.weixin.qq.com/cgi-bin/get_jsapi_ticket?access_token=qPKsmS32-uP1lM5g-YXgzCpRe7tKsJE2ijrUncNpoMZ-Bq_ouJMBFiZGViDt0Q9s9tL2fsX7GD0Ou6FND8-vt9VBYLfyFwR9Tj7NIoJ3f58JrAKeIkvJDs3KhaWSi1r1OWqogKHKK7spCBURRAgrEg6rNIstDlHkvyIXIkTiP4V5YCiTw1Er7l99ObdYAgVEjVuct8IZ1GO05detsxvuEQ
    let ticket = 'HoagFKDcsGMVCIY2vOjf9vv4iBsphx6wmdkIqBRrJdl0lTJ_xNQk8oJuM2E0dKP0T8VmGorOPY7z3TjNZuPmEA'


    let timestamp = new Date().getTime();

    let nonceStr = 'xxx123324dsdfaafa';

    let url = 'https://asset.felord.cn/blog/qywechat.html'
    let signatureStr = `jsapi_ticket=${ticket}&noncestr=${nonceStr}&timestamp=${timestamp}&url=${url}`

    let encode = CryptoJS.SHA1(signatureStr).toString(CryptoJS.enc.Hex);

    // 计算签名
    jWeixin.config({
        beta: true,// 必须这么写，否则wx.invoke调用形式的jsapi会有问题
        debug: true, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
        appId: corpId, // 必填，企业微信的corpID
        timestamp: timestamp, // 必填，生成签名的时间戳
        nonceStr: nonceStr, // 必填，生成签名的随机串
        signature: encode,// 必填，签名，见 附录-JS-SDK使用权限签名算法
        jsApiList: ['checkJsApi', 'getContext', 'sendChatMessage', 'agentConfig'], // 必填，需要使用的JS接口列表，凡是要调用的接口都需要传进来

    })


    jWeixin.ready(function () {
        console.log('111111111111111')
        // config信息验证后会执行ready方法，所有接口调用都必须在config接口获得结果之后，config是一个客户端的异步操作，
        // 所以如果需要在页面加载时就调用相关接口，则须把相关接口放在ready函数中调用来确保正确执行。对于用户触发时才调用的接口，则可以直接调用，不需要放在ready函数中。
    })
    jWeixin.error(function (res) {
        console.log("签名失败")
        //todo 更新签名
        //todo 再次失败阻断给出错误提示 并上报异常信息
        // config信息验证失败会执行error函数，如签名过期导致验证失败，具体错误信息可以打开config的debug模式查看，也可以在返回的res参数中查看，对于SPA可以在这里更新签名。
    });


    let timestamp1 = new Date().getTime();

    let nonceStr1 = 'xxx123324dsdsfdfffa';


    // accesstoken 公用
    // https://qyapi.weixin.qq.com/cgi-bin/ticket/get?access_token=qPKsmS32-uP1lM5g-YXgzCpRe7tKsJE2ijrUncNpoMZ-Bq_ouJMBFiZGViDt0Q9s9tL2fsX7GD0Ou6FND8-vt9VBYLfyFwR9Tj7NIoJ3f58JrAKeIkvJDs3KhaWSi1r1OWqogKHKK7spCBURRAgrEg6rNIstDlHkvyIXIkTiP4V5YCiTw1Er7l99ObdYAgVEjVuct8IZ1GO05detsxvuEQ&type=agent_config

    let ticket1 = 'OWDdlRrJAranVz37HqkyiA=='

    let signatureStr1 = `jsapi_ticket=${ticket1}&noncestr=${nonceStr1}&timestamp=${timestamp1}&url=${url}`

    let encode1 = CryptoJS.SHA1(signatureStr1).toString(CryptoJS.enc.Hex);


    jWeixin.agentConfig({
        corpid: corpId, // 必填，企业微信的corpid，必须与当前登录的企业一致
        agentid: agentId, // 必填，企业微信的应用id （e.g. 1000247）
        timestamp: timestamp1, // 必填，生成签名的时间戳
        nonceStr: nonceStr1, // 必填，生成签名的随机串
        signature: encode1,// 必填，签名，见附录-JS-SDK使用权限签名算法
        jsApiList: ['getContext', 'sendChatMessage'], //必填，传入需要使用的接口名称
        success: function (res) {
            alert(res)
        },
        fail: function (res) {
            if (res.errMsg.indexOf('function not exist') > -1) {
                alert('版本过低请升级')
            }
        }
    });


    function context() {
        jWeixin.invoke('getContext', {}, function (res) {
            if (res.err_msg == "getContext:ok") {
                document.getElementById('text').innerText = res.entry;
            } else {
                alert(res)
            }
        });
    }


    function send1() {
        jWeixin.invoke('sendChatMessage', {
            msgtype: "text", //消息类型，必填
            enterChat: true, //为true时表示发送完成之后顺便进入会话，仅移动端3.1.10及以上版本支持该字段
            text: {
                content: "你好！", //文本内容
            }
        }, function (res) {
            if (res.err_msg == 'sendChatMessage:ok') {
                alert('发送成功！')
            } else {
                alert(res)
            }
        })
    }

    function send2() {
        jWeixin.invoke('sendChatMessage', {
            msgtype: "news", //消息类型，必填
            enterChat: true, //为true时表示发送完成之后顺便进入会话，仅移动端3.1.10及以上版本支持该字段
            news:
                {
                    link: "https://blog.csdn.net/m0_45272038/article/details/118545940", //H5消息页面url 必填
                    title: "CSDN", //H5消息标题
                    desc: "技术分析", //H5消息摘要
                    imgUrl: "https://asset.felord.cn/blog/20210712002553.jpg", //H5消息封面图片URL
                }
        }, function (res) {
            if (res.err_msg == 'sendChatMessage:ok') {
                alert('发送成功！')
            } else {
                alert(res)
            }
        })
    }
</script>
</html>